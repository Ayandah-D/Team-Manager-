<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football GPS Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://unpkg.com/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        function Dashboard() {
            const [players, setPlayers] = useState([]);
            const [isConnected, setIsConnected] = useState(false);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                fetchPlayers();
                // Delay WebSocket connection to ensure server is ready
                setTimeout(() => {
                    connectWebSocket();
                }, 1000);
            }, []);
            
            const fetchPlayers = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    console.log('Fetching players from:', window.location.origin + '/api/players/active');
                    
                    const response = await fetch('/api/players/active', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
                    }
                    
                    const data = await response.json();
                    console.log('Received players data:', data);
                    setPlayers(data);
                } catch (error) {
                    console.error('Error fetching players:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const connectWebSocket = () => {
                try {
                    const socket = new SockJS('/ws');
                    const stompClient = Stomp.over(socket);
                    
                    stompClient.connect({}, function (frame) {
                        setIsConnected(true);
                        console.log('WebSocket Connected: ' + frame);
                        
                        stompClient.subscribe('/topic/gps/session_001', function (message) {
                            const gpsData = JSON.parse(message.body);
                            console.log('Received GPS data:', gpsData);
                        });
                    }, function(error) {
                        console.error('WebSocket connection error:', error);
                        setIsConnected(false);
                    });
                } catch (error) {
                    console.error('WebSocket setup error:', error);
                }
            };
            
            const createSamplePlayer = async () => {
                try {
                    const samplePlayer = {
                        name: "John Doe",
                        position: "Forward",
                        jerseyNumber: 9,
                        teamId: "team_001",
                        dateOfBirth: "1995-05-15",
                        height: 180,
                        weight: 75,
                        deviceId: "GPS_SAMPLE_001",
                        active: true,
                        profile: {
                            maxSpeed: 32.5,
                            averageSpeed: 12.0,
                            maxHeartRate: 190,
                            restingHeartRate: 50,
                            preferredPositions: ["ST", "LW"],
                            fitnessLevel: 8.5
                        }
                    };
                    
                    const response = await fetch('/api/players', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(samplePlayer)
                    });
                    
                    if (response.ok) {
                        fetchPlayers(); // Refresh the list
                    } else {
                        console.error('Failed to create sample player');
                    }
                } catch (error) {
                    console.error('Error creating sample player:', error);
                }
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading dashboard...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-100 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-8">
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                Football GPS Dashboard
                            </h1>
                            <div className="flex items-center gap-4">
                                <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                                    isConnected 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-red-100 text-red-800'
                                }`}>
                                    {isConnected ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected'}
                                </div>
                                <button 
                                    onClick={fetchPlayers}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Refresh
                                </button>
                                {players.length === 0 && !error && (
                                    <button 
                                        onClick={createSamplePlayer}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                    >
                                        Add Sample Player
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                                <strong>Error:</strong> {error}
                                <br />
                                <small>Check the browser console for more details.</small>
                            </div>
                        )}
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {players.map(player => (
                                <div key={player.id} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold">{player.name}</h3>
                                        <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono">
                                            #{player.jerseyNumber}
                                        </span>
                                    </div>
                                    <p className="text-gray-600 mb-2">Position: {player.position}</p>
                                    <p className="text-gray-500 text-sm mb-3">Device: {player.deviceId}</p>
                                    <div className="flex items-center gap-2">
                                        <div className={`w-3 h-3 rounded-full ${player.active ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                                        <span className="text-sm text-gray-500">
                                            {player.active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    {player.profile && (
                                        <div className="mt-4 pt-4 border-t border-gray-200">
                                            <div className="grid grid-cols-2 gap-2 text-sm">
                                                <div>
                                                    <span className="text-gray-500">Max Speed:</span>
                                                    <span className="ml-1 font-medium">{player.profile.maxSpeed} km/h</span>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Fitness:</span>
                                                    <span className="ml-1 font-medium">{player.profile.fitnessLevel}/10</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        
                        {players.length === 0 && !error && (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">âš½</div>
                                <p className="text-gray-500 text-lg mb-2">No active players found</p>
                                <p className="text-gray-400 mb-4">Add players to start tracking their performance</p>
                                <button 
                                    onClick={createSamplePlayer}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Add Sample Player
                                </button>
                            </div>
                        )}
                        
                        {/* Debug Information */}
                        <div className="mt-8 p-4 bg-gray-50 rounded-lg">
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Debug Information</h3>
                            <div className="text-xs text-gray-600 space-y-1">
                                <div>Current URL: {window.location.href}</div>
                                <div>API Base: {window.location.origin}/api</div>
                                <div>Players Count: {players.length}</div>
                                <div>WebSocket Status: {isConnected ? 'Connected' : 'Disconnected'}</div>
                                <div>Last Error: {error || 'None'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
